<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soure</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="index-landing">
    <div class="index-hero">
      <h1 class="index-title">Soure</h1>
      <p class="index-subtitle">Roll dice. Lose friends. Gain empire.</p>
      <div class="index-pills">
        <button type="button" class="index-pill" id="pillRules" aria-label="View Soure rules">Soure Rules</button>
        <button type="button" class="index-pill" id="pillPeople" aria-label="About people">People can't be bought.</button>
      </div>
    </div>

    <nav class="index-tiles" aria-label="Main navigation">
      <a href="/game" class="index-tile index-tile--game" id="tileGame" aria-label="Enter game lobby">Game</a>
      <a href="/friends" class="index-tile index-tile--friends" id="tileFriends" aria-label="Friends">Friends</a>
      <button type="button" class="index-tile index-tile--resources" id="tileResources" aria-label="Resources">Resources</button>
      <button type="button" class="index-tile index-tile--settings" id="tileSettings" aria-label="Open settings">Settings</button>
      <a href="#" class="index-tile index-tile--reconnect hidden" id="tileReconnect" aria-label="Reconnect to your game">Reconnect</a>
      <a href="/register" class="index-tile index-tile--register hidden" id="tileRegister" aria-label="Register">Register</a>
      <a href="/login" class="index-tile index-tile--login hidden" id="tileLogin" aria-label="Log in">Login</a>
    </nav>

    <div id="loggedInCaption" class="index-logged-in hidden">
      Logged in as: <span id="loggedInUsername"></span>
    </div>

    <div id="indexRejoinBanner" class="index-rejoin-banner hidden" role="status">
      <span class="index-rejoin-text">You were disconnected. Rejoin your current game.</span>
      <a href="#" class="btn btn-primary" id="indexRejoinBtn" aria-label="Rejoin your current game">Rejoin Game</a>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModal" class="index-modal hidden" aria-hidden="true">
    <div class="index-modal-backdrop" id="settingsModalBackdrop"></div>
    <div class="index-modal-panel">
      <h2 class="index-modal-title">Settings</h2>
      <section class="index-settings-account">
        <h3>Account</h3>
        <p id="settingsUsername" class="index-settings-username">—</p>
        <p id="settingsSessionStatus" class="index-settings-muted">Session active</p>
      </section>
      <div class="index-modal-actions">
        <button type="button" class="btn btn-danger" id="settingsLogoutBtn">Logout</button>
        <button type="button" class="btn" id="settingsCloseBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      const $ = (id) => document.getElementById(id);

      function showLoggedOut() {
        const tileLogin = $("tileLogin");
        const tileRegister = $("tileRegister");
        const caption = $("loggedInCaption");
        if (tileLogin) tileLogin.classList.remove("hidden");
        if (tileRegister) tileRegister.classList.remove("hidden");
        if (caption) caption.classList.add("hidden");
      }

      function showLoggedIn(user) {
        const tileLogin = $("tileLogin");
        const tileRegister = $("tileRegister");
        const caption = $("loggedInCaption");
        const usernameEl = $("loggedInUsername");
        if (tileLogin) tileLogin.classList.add("hidden");
        if (tileRegister) tileRegister.classList.add("hidden");
        if (caption) caption.classList.remove("hidden");
        if (usernameEl && user) usernameEl.textContent = user.username;
      }

      function checkAuth() {
        fetch("/api/me", { credentials: "same-origin" })
          .then((r) => r.json())
          .then((data) => {
            if (data.ok && data.user) {
              showLoggedIn(data.user);
            } else {
              showLoggedOut();
            }
          })
          .catch((err) => {
            console.error("[index] Auth check failed:", err);
            showLoggedOut();
          });
      }

      function openSettingsModal() {
        const modal = $("settingsModal");
        const usernameEl = $("settingsUsername");
        fetch("/api/me", { credentials: "same-origin" })
          .then((r) => r.json())
          .then((data) => {
            if (data.ok && data.user) {
              if (usernameEl) usernameEl.textContent = data.user.username;
            } else {
              if (usernameEl) usernameEl.textContent = "Not logged in";
            }
          })
          .catch(() => { if (usernameEl) usernameEl.textContent = "—"; });
        if (modal) {
          modal.classList.remove("hidden");
          modal.setAttribute("aria-hidden", "false");
        }
      }

      function closeSettingsModal() {
        const modal = $("settingsModal");
        if (modal) {
          modal.classList.add("hidden");
          modal.setAttribute("aria-hidden", "true");
        }
      }

      function doLogout() {
        fetch("/api/logout", { method: "POST", credentials: "same-origin" })
          .then(() => {
            closeSettingsModal();
            window.location.href = "/";
          })
          .catch((err) => {
            console.error("[index] Logout failed:", err);
            closeSettingsModal();
            window.location.href = "/";
          });
      }

      $("tileSettings").addEventListener("click", function (e) {
        e.preventDefault();
        openSettingsModal();
      });

      const resourcesBtn = $("tileResources");
      if (resourcesBtn) resourcesBtn.addEventListener("click", () => alert("Coming soon"));

      $("settingsModalBackdrop").addEventListener("click", closeSettingsModal);
      $("settingsCloseBtn").addEventListener("click", closeSettingsModal);
      $("settingsLogoutBtn").addEventListener("click", doLogout);

      // Reconnect: show only when server says user has an active rejoinable game (not just localStorage).
      // lastGameId is stored in localStorage when user creates/joins/starts a game (see game.js).
      function checkRejoin() {
        fetch("/api/active-game", { credentials: "same-origin" })
          .then((r) => r.json())
          .then((data) => {
            if (!data.ok || !data.gameId) {
              hideReconnectTile();
              return;
            }
            const gameId = data.gameId;
            const banner = $("indexRejoinBanner");
            const rejoinBtn = $("indexRejoinBtn");
            if (banner) banner.classList.remove("hidden");
            if (rejoinBtn) rejoinBtn.href = "/play/" + gameId;

            const tileReconnect = $("tileReconnect");
            if (tileReconnect) {
              tileReconnect.href = "/play/" + gameId;
              tileReconnect.classList.remove("hidden");
              applyReconnectPosition(tileReconnect);
            }
          })
          .catch(() => { hideReconnectTile(); });
      }

      function hideReconnectTile() {
        const tileReconnect = $("tileReconnect");
        if (tileReconnect) tileReconnect.classList.add("hidden");
      }

      // Random but safe position: one of 4 predefined positions (no overlap with other tiles).
      function applyReconnectPosition(el) {
        const positions = ["index-tile--reconnect-1", "index-tile--reconnect-2", "index-tile--reconnect-3", "index-tile--reconnect-4"];
        positions.forEach((c) => el.classList.remove(c));
        const idx = Math.floor(Math.random() * positions.length);
        el.classList.add(positions[idx]);
      }

      const pillRules = $("pillRules");
      if (pillRules) pillRules.addEventListener("click", () => alert("Coming soon"));
      const pillPeople = $("pillPeople");
      if (pillPeople) pillPeople.addEventListener("click", () => alert("Coming soon"));

      checkAuth();
      checkRejoin();
    })();
  </script>
</body>
</html>
